<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mocca Super App</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style> 
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        
        /* Animasi Gradient Background Login */
        .animate-gradient {
            background-size: 200% 200%;
            animation: gradientMove 6s ease infinite;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } 
        
        .active-tab { 
            background: #4f46e5; 
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-indigo-500 selection:text-white">

    <div id="login-screen" class="flex flex-col items-center justify-center h-screen w-full bg-gradient-to-br from-indigo-900 via-purple-900 to-slate-900 animate-gradient text-white p-6 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-64 h-64 bg-indigo-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute bottom-0 right-0 w-64 h-64 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>

        <div class="relative z-10 text-center glass p-8 rounded-3xl shadow-2xl border border-white/10 max-w-sm w-full">
            <div class="mb-6 inline-block p-4 rounded-2xl bg-indigo-50/10">
                <img src="icon.png" class="w-16 h-16 rounded-xl shadow-lg mx-auto" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2921/2921226.png'">
            </div>
            <h1 class="text-2xl font-bold mb-1 text-slate-800">Studio HRIS</h1>
            <p class="text-slate-500 text-sm mb-8">System Absensi Terintegrasi</p>
            
            <button onclick="loginGoogle()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all active:scale-95 group">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5 group-hover:rotate-12 transition">
                <span>Masuk dengan Google</span>
            </button>
        </div>
        <p class="absolute bottom-6 text-white/30 text-xs">v6.0 ‚Ä¢ Creative Studio Edition</p>
    </div>

    <div id="profile-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4 sm:p-6 fade-in">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl shadow-2xl w-full max-w-md p-6 text-slate-800 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">Edit Profil</h2>
                <button onclick="tutupProfile()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-red-100 text-gray-500 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="space-y-5">
                <div class="text-center">
                    <div class="relative inline-block group">
                        <img id="preview-foto-profil" src="" class="w-28 h-28 rounded-full mx-auto border-4 border-indigo-50 shadow-lg object-cover">
                        <label class="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full cursor-pointer hover:bg-indigo-700 shadow-lg transition transform group-hover:scale-110">
                            <i class="fa-solid fa-camera text-xs"></i>
                            <input type="file" id="input-foto-file" class="hidden" accept="image/*" onchange="previewImage(this)">
                        </label>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Ketuk ikon kamera untuk ganti foto</p>
                </div>

                <div>
                    <label class="block font-semibold text-xs text-slate-500 uppercase tracking-wide mb-1.5">Nama Lengkap</label>
                    <input type="text" id="edit-nama" class="w-full border border-gray-200 bg-gray-50 rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:bg-white transition outline-none font-medium">
                </div>

                <div>
                    <label class="block font-semibold text-xs text-slate-500 uppercase tracking-wide mb-1.5">Tanggal Lahir</label>
                    <input type="date" id="edit-tgl-lahir" class="w-full border border-gray-200 bg-gray-50 rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 focus:bg-white transition outline-none font-medium">
                </div>

                <div>
                    <label class="block font-semibold text-xs text-slate-500 uppercase tracking-wide mb-1.5">Divisi</label>
                    <div class="relative">
                        <select id="edit-divisi" class="w-full border border-gray-200 bg-gray-50 rounded-xl p-3 appearance-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition outline-none font-medium">
                            <option value="3D Anim">3D Anim</option>
                            <option value="3D Asset">3D Asset</option>
                            <option value="Rigger">Rigger</option>
                            <option value="Layout">Layout</option>
                            <option value="Editor/LRC">Editor / LRC</option>
                            <option value="2D Anim">2D Anim</option>
                            <option value="2D Ilustrasi">2D Ilustrasi</option>
                            <option value="Lovy Merchandise">Lovy Merchandise</option>
                            <option value="Cafe/Kitchen">Cafe / Kitchen</option>
                            <option value="IT/Minebi">IT / Minebi</option>
                            <option value="Management">Management</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <button onclick="updateProfileData()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition active:scale-95">
                    SIMPAN PERUBAHAN
                </button>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden flex h-screen overflow-hidden bg-gray-50">
        <div class="flex-1 flex flex-col h-screen overflow-hidden max-w-md mx-auto w-full bg-white shadow-2xl relative">
            
            <header class="glass sticky top-0 z-20 px-5 py-4 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="bukaProfile()">
                    <div class="relative">
                        <img id="user-photo" src="" class="w-11 h-11 rounded-full border-2 border-white shadow-md object-cover group-hover:border-indigo-200 transition">
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                    </div>
                    <div>
                        <p id="user-name-display" class="text-sm font-bold text-slate-800 leading-tight">Loading...</p>
                        <p id="user-divisi-display" class="text-[11px] text-indigo-500 font-semibold tracking-wide">...</p>
                    </div>
                </div>
                <button onclick="logoutGoogle()" class="w-9 h-9 rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition flex items-center justify-center shadow-sm">
                    <i class="fa-solid fa-power-off text-sm"></i>
                </button>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto p-5 scroll-smooth pb-24">
                
                <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-3xl p-6 text-white shadow-xl shadow-indigo-200 mb-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
                    <div class="absolute bottom-0 left-0 -mb-4 -ml-4 w-20 h-20 bg-indigo-400 opacity-20 rounded-full blur-xl"></div>

                    <div class="text-center relative z-10">
                        <p class="text-indigo-100 text-[10px] font-medium tracking-[0.2em] uppercase mb-1">Waktu Server</p>
                        <h1 id="clock-display" class="text-4xl font-bold tracking-tight font-mono mb-2">...</h1>
                        
                        <div class="inline-flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full backdrop-blur-md border border-white/10">
                            <i class="fa-solid fa-satellite-dish text-[10px] text-green-300 animate-pulse"></i>
                            <p id="gps-status" class="text-[10px] font-medium">Mencari Satelit...</p>
                        </div>
                        <p id="jarak-status" class="text-[10px] font-bold mt-2 hidden bg-white/20 inline-block px-2 py-0.5 rounded"></p>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-1 mb-8">
                    <div id="camera-container" class="hidden relative rounded-2xl overflow-hidden bg-black aspect-[4/3]">
                        <video id="video-preview" class="w-full h-full object-cover" autoplay playsinline></video>
                        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/70 to-transparent p-4">
                            <p class="text-white text-xs text-center">Pastikan wajah terlihat jelas</p>
                        </div>
                    </div>

                    <div class="p-4">
                        <div class="grid grid-cols-1 gap-4">
                            <div class="bg-gray-50 rounded-xl p-1 flex border border-gray-100 relative">
                                <i class="fa-solid fa-list-check absolute left-4 top-4 text-gray-400"></i>
                                <select id="jenis-absen" onchange="aturForm()" class="w-full bg-transparent p-3 pl-10 font-semibold text-slate-700 outline-none text-sm appearance-none">
                                    <option value="Masuk">‚òÄÔ∏è Absen Masuk</option>
                                    <option value="Pulang">üåô Absen Pulang</option>
                                    <option value="IzinSakit">ü§í Izin / Sakit</option>
                                    <option value="Cuti">üèñÔ∏è Cuti Kerja</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-gray-400 text-xs pointer-events-none"></i>
                            </div>

                            <div id="container-status" class="relative">
                                <i class="fa-solid fa-map-pin absolute left-4 top-4 text-gray-400 z-10"></i>
                                <div class="relative">
                                    <select id="status-absen" class="w-full bg-white border border-gray-200 rounded-xl p-3 pl-10 font-medium text-slate-600 outline-none text-sm appearance-none focus:ring-2 focus:ring-indigo-500 transition">
                                        </select>
                                    <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-gray-400 text-xs pointer-events-none"></i>
                                </div>
                            </div>

                            <div id="container-keterangan" class="hidden">
                                <textarea id="input-keterangan" rows="2" class="w-full bg-white border border-gray-200 rounded-xl p-3 font-medium text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Tulis alasan lengkap..."></textarea>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button id="btn-open-camera" onclick="bukaKamera()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg transition flex items-center justify-center gap-2 active:scale-95">
                                <i class="fa-solid fa-camera"></i> BUKA KAMERA
                            </button>
                            <button id="btn-capture" onclick="jepretDanKirim()" class="hidden w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:opacity-90 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transition flex items-center justify-center gap-2 active:scale-95">
                                <i class="fa-solid fa-paper-plane"></i> KIRIM ABSEN
                            </button>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-4 px-1">
                        <h3 class="font-bold text-slate-800 text-lg">Riwayat</h3>
                        <button onclick="downloadLaporan()" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2">
                            <i class="fa-solid fa-file-excel"></i> Export
                        </button>
                    </div>

                    <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar mb-2">
                        <button onclick="gantiTab('all')" id="tab-all" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap active-tab transition border border-transparent">Semua</button>
                        <button onclick="gantiTab('wfo')" id="tab-wfo" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap bg-white text-gray-500 border border-gray-200 hover:border-indigo-300 transition">WFO</button>
                        <button onclick="gantiTab('wfh')" id="tab-wfh" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap bg-white text-gray-500 border border-gray-200 hover:border-indigo-300 transition">WFH</button>
                        <button onclick="gantiTab('pulang')" id="tab-pulang" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap bg-white text-gray-500 border border-gray-200 hover:border-indigo-300 transition">Pulang</button>
                        <button onclick="gantiTab('sakit')" id="tab-sakit" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap bg-white text-gray-500 border border-gray-200 hover:border-indigo-300 transition">Izin</button>
                        <button onclick="gantiTab('cuti')" id="tab-cuti" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap bg-white text-gray-500 border border-gray-200 hover:border-indigo-300 transition">Cuti</button>
                    </div>

                    <div id="tabel-body" class="space-y-3">
                        </div>
                    <p id="empty-msg" class="hidden text-center text-gray-400 py-10 text-sm italic">Belum ada data hari ini.</p>
                </div>

                <div class="h-10"></div> </main>
        </div>
    </div>

    <div id="image-modal" class="fixed inset-0 bg-black/95 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm" onclick="tutupModal()">
        <img id="modal-img" src="" class="max-w-full max-h-[85vh] rounded-xl shadow-2xl ring-4 ring-white/10">
        <button class="absolute top-6 right-6 text-white text-xl opacity-70 hover:opacity-100"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, getDocs, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ============================================
        // SETTING
        // ============================================
        const KANTOR_LAT = -7.988571; // <--- GANTI
        const KANTOR_LONG = 112.652931; // <--- GANTI
        const MAX_JARAK_METER = 100;
        const JAM_MASUK_KANTOR = 10; 
        const MENIT_MASUK_KANTOR = 0; 

        const firebaseConfig = {
            apiKey: "AIzaSyCdftKyUcSnj3e5yoTW1UiSOkZMEPwJiI4",
            authDomain: "moccabsent.firebaseapp.com",
            projectId: "moccabsent",
            storageBucket: "moccabsent.firebasestorage.app",
            messagingSenderId: "196522769704",
            appId: "1:196522769704:web:e84c7206d81288723ea41d"
        };
        // ============================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let userProfile = {}; 
        let compressedProfileImage = ""; 
        let videoStream = null;
        let currentLat = null, currentLong = null;
        let allData = [];
        let currentTab = 'all';

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    renderHeader();
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-screen').classList.remove('hidden');
                    aturForm();
                } else {
                    userProfile = { nama_lengkap: user.displayName, divisi: "", tgl_lahir: "", photoURL: user.photoURL };
                    bukaProfile();
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-screen').classList.remove('hidden');
                }
            } else {
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        function renderHeader() {
            document.getElementById('user-photo').src = userProfile.photoURL || 'icon.png';
            document.getElementById('user-name-display').innerText = userProfile.nama_lengkap || currentUser.displayName;
            document.getElementById('user-divisi-display').innerText = userProfile.divisi || "Divisi Belum Diisi";
        }

        window.bukaProfile = () => {
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('preview-foto-profil').src = userProfile.photoURL || currentUser.photoURL;
            document.getElementById('edit-nama').value = userProfile.nama_lengkap || "";
            document.getElementById('edit-divisi').value = userProfile.divisi || "";
            document.getElementById('edit-tgl-lahir').value = userProfile.tgl_lahir || "";
        }

        window.tutupProfile = () => {
            if(!userProfile.divisi) return alert("Divisi wajib diisi!");
            document.getElementById('profile-modal').classList.add('hidden');
        }

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 300;
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        compressedProfileImage = canvas.toDataURL('image/jpeg', 0.7);
                        document.getElementById('preview-foto-profil').src = compressedProfileImage;
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.updateProfileData = async () => {
            const nama = document.getElementById('edit-nama').value;
            const divisi = document.getElementById('edit-divisi').value;
            const tgl = document.getElementById('edit-tgl-lahir').value;
            const finalPhoto = compressedProfileImage || userProfile.photoURL;

            if(!nama || !divisi) return alert("Nama & Divisi wajib diisi!");
            if (finalPhoto.length > 1000000) return alert("Foto terlalu besar!");

            try {
                const newData = { nama_lengkap: nama, divisi: divisi, tgl_lahir: tgl, photoURL: finalPhoto, email: currentUser.email };
                await setDoc(doc(db, "users", currentUser.uid), newData, { merge: true });
                userProfile = newData;
                renderHeader();
                tutupProfile();
                compressedProfileImage = ""; 
                alert("Profil Tersimpan!");
            } catch (e) { alert("Gagal: " + e.message); }
        }

        window.loginGoogle = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.logoutGoogle = () => { if(confirm("Keluar aplikasi?")) signOut(auth); };

        window.aturForm = () => {
            const jenis = document.getElementById('jenis-absen').value;
            const selectStatus = document.getElementById('status-absen');
            const boxStatus = document.getElementById('container-status');
            const boxKet = document.getElementById('container-keterangan');

            selectStatus.innerHTML = "";
            if (jenis === 'Masuk') {
                boxStatus.classList.remove('hidden'); boxKet.classList.add('hidden');
                selectStatus.innerHTML += `<option value="Hadir (WFO)">üè¢ Hadir (WFO - Kantor)</option>`;
                selectStatus.innerHTML += `<option value="Hadir (WFH)">üè† Hadir (WFH - Rumah)</option>`;
            } else if (jenis === 'Pulang') {
                boxStatus.classList.add('hidden'); boxKet.classList.add('hidden');
            } else if (jenis === 'IzinSakit') {
                boxStatus.classList.remove('hidden'); boxKet.classList.remove('hidden');
                selectStatus.innerHTML += `<option value="Sakit">ü§í Sakit</option><option value="Izin">‚ö†Ô∏è Izin</option>`;
            } else if (jenis === 'Cuti') {
                boxStatus.classList.remove('hidden'); boxKet.classList.remove('hidden');
                selectStatus.innerHTML += `<option value="Cuti">üèñÔ∏è Cuti</option>`;
            }
        }

        function hitungJarak(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const œÜ1 = lat1 * Math.PI/180, œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180, ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2)*Math.sin(ŒîœÜ/2) + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)*Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        window.bukaKamera = async () => {
            if(!userProfile.divisi) return bukaProfile();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                videoStream = stream;
                document.getElementById('video-preview').srcObject = stream;
                document.getElementById('camera-container').classList.remove('hidden');
                document.getElementById('btn-open-camera').classList.add('hidden');
                document.getElementById('btn-capture').classList.remove('hidden');
                
                document.getElementById('gps-status').innerText = "Mencari GPS...";
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((pos) => {
                        currentLat = pos.coords.latitude;
                        currentLong = pos.coords.longitude;
                        const jarak = Math.round(hitungJarak(currentLat, currentLong, KANTOR_LAT, KANTOR_LONG));
                        document.getElementById('gps-status').innerHTML = `<span class="text-green-300 font-bold">GPS Terkunci</span>`;
                        const info = document.getElementById('jarak-status');
                        info.innerText = `${jarak}m dari kantor`;
                        info.classList.remove('hidden');
                        info.className = (jarak > MAX_JARAK_METER) ? "text-[10px] font-bold bg-red-500/80 rounded px-2 mt-1" : "text-[10px] font-bold bg-green-500/80 rounded px-2 mt-1";
                    });
                }
            } catch (err) { alert("Gagal kamera: " + err.message); }
        };

        window.jepretDanKirim = async () => {
            if (!videoStream || !currentLat) return alert("Tunggu GPS Terkunci!");
            
            const jenis = document.getElementById('jenis-absen').value;
            let status = (jenis === 'Pulang') ? "Pulang" : document.getElementById('status-absen').value;
            const keterangan = document.getElementById('input-keterangan').value;

            if (jenis === 'Masuk' && status === 'Hadir (WFO)') {
                const jarak = hitungJarak(currentLat, currentLong, KANTOR_LAT, KANTOR_LONG);
                if (jarak > MAX_JARAK_METER) return alert(`Kejauhan! (${Math.round(jarak)}m). Ke kantor atau pilih WFH.`);
            }

            if ((jenis === 'IzinSakit' || jenis === 'Cuti') && !keterangan.trim()) return alert("Isi keterangan!");

            if (jenis === 'Masuk') {
                const now = new Date();
                if (now.getHours() > JAM_MASUK_KANTOR || (now.getHours() === JAM_MASUK_KANTOR && now.getMinutes() > MENIT_MASUK_KANTOR)) {
                    status += " (TERLAMBAT)";
                }
            }

            const video = document.getElementById('video-preview');
            const canvas = document.createElement('canvas');
            canvas.width = 640; canvas.height = 480;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = "rgba(0, 0, 0, 0.6)"; ctx.fillRect(0, canvas.height - 80, canvas.width, 80);
            ctx.fillStyle = "white"; ctx.font = "bold 20px sans-serif";
            const now = new Date();
            ctx.fillText(`${userProfile.nama_lengkap} ‚Ä¢ ${status}`, 20, canvas.height - 50);
            ctx.font = "14px sans-serif";
            ctx.fillText(`üìç ${currentLat.toFixed(6)}, ${currentLong.toFixed(6)} ‚Ä¢ ${now.toLocaleString('id-ID')}`, 20, canvas.height - 25);
            
            const fotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
            videoStream.getTracks().forEach(t => t.stop());
            document.getElementById('camera-container').classList.add('hidden');
            document.getElementById('btn-open-camera').classList.remove('hidden');
            document.getElementById('btn-capture').classList.add('hidden');
            document.getElementById('input-keterangan').value = "";

            try {
                await addDoc(collection(db, "absensi"), {
                    uid: currentUser.uid, nama: userProfile.nama_lengkap, divisi: userProfile.divisi, foto_profil: userProfile.photoURL,
                    bukti_foto: fotoBase64, kategori: jenis, status: status, keterangan: keterangan,
                    lokasi: `${currentLat}, ${currentLong}`, waktu: now.toLocaleTimeString('id-ID'), tanggal: now.toLocaleDateString('id-ID'), timestamp: now
                });
                alert("Berhasil! ‚ú®");
            } catch (e) { alert("Error: " + e.message); }
        };

        const q = query(collection(db, "absensi"), orderBy("timestamp", "desc"), limit(50));
        onSnapshot(q, (snapshot) => {
            allData = [];
            snapshot.forEach(doc => allData.push(doc.data()));
            renderTabel();
        });

        window.gantiTab = (tabName) => {
            currentTab = tabName;
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
                btn.className = "px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap bg-white text-gray-500 border border-gray-200 hover:border-indigo-300 transition";
            });
            document.getElementById(`tab-${tabName}`).className = "px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap active-tab transition border border-transparent";
            renderTabel();
        };

        function renderTabel() {
            const container = document.getElementById('tabel-body');
            container.innerHTML = "";
            
            const filteredData = allData.filter(d => {
                if (currentTab === 'all') return true;
                if (currentTab === 'wfo') return d.kategori === 'Masuk' && d.status.includes('WFO');
                if (currentTab === 'wfh') return d.kategori === 'Masuk' && d.status.includes('WFH');
                if (currentTab === 'pulang') return d.kategori === 'Pulang';
                if (currentTab === 'sakit') return d.kategori === 'IzinSakit';
                if (currentTab === 'cuti') return d.kategori === 'Cuti';
                return false;
            });

            if(filteredData.length === 0) {
                document.getElementById('empty-msg').classList.remove('hidden');
            } else {
                document.getElementById('empty-msg').classList.add('hidden');
                filteredData.forEach(data => {
                    let badgeClass = "bg-gray-100 text-gray-600 border-gray-200";
                    let icon = "fa-check";
                    
                    if(data.status.includes('WFO')) { badgeClass = "bg-blue-50 text-blue-600 border-blue-200"; icon="fa-building"; }
                    else if(data.status.includes('WFH')) { badgeClass = "bg-cyan-50 text-cyan-600 border-cyan-200"; icon="fa-house-laptop"; }
                    else if(data.status.includes('Sakit')) { badgeClass = "bg-yellow-50 text-yellow-600 border-yellow-200"; icon="fa-bed-pulse"; }
                    else if(data.status.includes('Cuti')) { badgeClass = "bg-purple-50 text-purple-600 border-purple-200"; icon="fa-umbrella-beach"; }
                    else if(data.status.includes('Pulang')) { badgeClass = "bg-orange-50 text-orange-600 border-orange-200"; icon="fa-person-walking-arrow-right"; }

                    let lateUI = data.status.includes("TERLAMBAT") ? `<span class="bg-red-100 text-red-600 px-1.5 py-0.5 rounded text-[9px] font-bold border border-red-200">TELAT</span>` : "";

                    container.innerHTML += `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex gap-4 items-start fade-in">
                            <div class="flex-shrink-0 relative group">
                                <img src="${data.bukti_foto}" class="w-16 h-16 object-cover rounded-xl shadow-sm cursor-pointer hover:scale-105 transition" onclick="bukaFoto('${data.bukti_foto}')">
                                <div class="absolute -bottom-2 -right-2 bg-white rounded-full p-1 shadow-sm">
                                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] ${badgeClass.split(' ')[0]} ${badgeClass.split(' ')[1]}">
                                        <i class="fa-solid ${icon}"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h4 class="font-bold text-slate-800 text-sm truncate">${data.nama}</h4>
                                    <span class="text-[10px] font-mono text-gray-400 bg-gray-50 px-1.5 rounded">${data.waktu}</span>
                                </div>
                                <p class="text-xs text-indigo-500 font-medium mb-1">${data.divisi}</p>
                                <div class="flex items-center gap-1 flex-wrap">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${badgeClass}">${data.status.replace(" (TERLAMBAT)", "")}</span>
                                    ${lateUI}
                                </div>
                                ${data.keterangan ? `<p class="text-xs text-gray-500 mt-2 italic bg-gray-50 p-2 rounded-lg border border-gray-100">"${data.keterangan}"</p>` : ''}
                            </div>
                        </div>`;
                });
            }
        }

        window.bukaFoto = (src) => { document.getElementById('modal-img').src = src; document.getElementById('image-modal').classList.remove('hidden'); }
        window.tutupModal = () => { document.getElementById('image-modal').classList.add('hidden'); }
        window.downloadLaporan = async () => {
            if (!confirm("Download Excel?")) return;
            const snap = await getDocs(query(collection(db, "absensi"), orderBy("timestamp", "desc")));
            let csv = "data:text/csv;charset=utf-8,Tanggal,Jam,Nama,Divisi,Kategori,Status,Keterangan,Lokasi\n";
            snap.forEach(d => {
                const data = d.data();
                const safeKet = data.keterangan ? data.keterangan.replace(/,/g, " ") : "-";
                csv += `${data.tanggal},${data.waktu},"${data.nama}","${data.divisi}","${data.kategori}","${data.status}","${safeKet}","${data.lokasi}"\n`;
            });
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "Laporan_Absensi_Studio.csv";
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        setInterval(() => document.getElementById('clock-display').innerText = new Date().toLocaleTimeString('id-ID'), 1000);
    </script>
    <script> if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js'); </script>
</body>
</html>